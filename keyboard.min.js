$.fn.keyboard=function(e){function t(e){var t=new Array,a="";return void 0!==e&&""!=e?(t=e.trim().split(","),$.each(t,function(e,t){a+="contenteditable"==t.trim().toString()?'[contenteditable="true"], ':"textarea"==t.trim().toString()?"textarea, ":'input[type="'+t.trim().toString()+'"], '}),a=a.slice(0,-2)):a='input[type="text"], input[type="number"], input[type="password"], input[type="search"], input[type="tel"], input[type="url"], textarea, [contenteditable="true"]',a}function a(){v=0,r(e.language[v]),S.on("focus click touch",e.inputType,function(){"keyboard-input-field"!=$(this).prop("class")&&(w=$(this),w.is("input")?($(".keyboard-input-field").val(w.val()),$(".keyboard-input-field").prop("type",w.prop("type"))):($(".keyboard-input-field").val(w.html()),$(".keyboard-input-field").prop("type","text")),$(".keyboard-blackout-background").show(),$(".keyboard-wrapper").show(),q=!0,$(".keyboard-input-field").focus())}),$(document).on("click touch",".keyboard-key",function(){var e=$(this).data("keyval");"tel"!=$(".keyboard-input-field").prop("type")&&"number"!=$(".keyboard-input-field").prop("type")?k(e):"tel"!=$(".keyboard-input-field").prop("type")&&"number"!=$(".keyboard-input-field").prop("type")||!(e.match(/\d/)||e.length>2)||k(e)}),$(document).on("click touch",".keyboard-cancel-button",function(){b()}),$(document).on("click touch",".keyboard-accept-button",function(){u()}),$(document).on("keydown",function(e){keyCodeStored=e.which,o(e)})}function o(t){if($(".keyboard-wrapper").is(":visible"))switch(t.which){case 13:e.allowEnterAccept&&(u(),t.preventDefault());break;case 27:e.allowEscapeCancel&&(b(),t.preventDefault())}}function r(e){var t="p";""!=A.keyboardFile&&A.arrayPosition==v?l(e,A.keyboardFile):$.get("languages/"+e+".klc",function(a){A.keyboardFile=a,A.arrayPosition=v,t="data",l(e,a)})}function l(e,t){var a,o,r,l,i,c="",d="",p="",y=new Array;C="",m="",x="",t=t.replace(/\u0000/g,""),a=t.match(/\d(\w)?\s+\w+\s+\d\s+(-1|\w+@?|%%)\s+(-1|\w+@?|%%)\s+(-1|\w+@?|%%)(\s+(-1|\w+@?|%%))?(\s+(-1|\w+@?|%%))?(\s+(-1|\w+@?|%%))?\s+\/\//g),c=t.indexOf("SHIFTSTATE"),c>0&&(o=t.slice(c,t.indexOf("LAYOUT")).trim().split(/\n/g),o.splice(0,2),$.each(o,function(e,t){t.indexOf(":")==-1?C+='"default": ':t.indexOf("Shft  Ctrl Alt")!=-1?C+='"shift_altgrp": ':t.indexOf("Shft  Ctrl")!=-1?C+='"ctrl_shift": ':t.indexOf("Ctrl Alt")!=-1?C+='"altgrp": ':t.indexOf("Ctrl")!=-1?C+='"ctrl": ':t.indexOf("Shft")!=-1&&(C+='"shift": '),C+=t.match(/\w{6}\s[0-9]/).toString().slice(-1)+", "}),C=JSON.parse("{"+C.toString().slice(0,-2)+"}")),d=t.indexOf("DEADKEY"),d>0&&(r=t.slice(d,t.indexOf("KEYNAME")).trim().split("DEADKEY"),r.splice(0,1),$.each(r,function(e,t){y=t.split(/\n/g),y.splice(0,2),i="",$.each(y,function(e,t){i+='"'+t.trim().slice(0,4)+'": "'+t.trim().slice(5,9)+'", '}),i="{"+i.slice(0,-2)+"}",m+='"'+t.trim().slice(0,4)+'": '+i+", "}),m=JSON.parse("{"+m.slice(0,-2)+"}")),p=t.indexOf("LIGATURE"),p>0&&(l=t.slice(p,t.indexOf("KEYNAME")).trim().split(/\n/g),l.splice(0,5),$.each(l,function(e,t){t.indexOf("//")>0&&(l[e]=t.trim().split("//")[0].trim().replace(/\t/g," ").replace("  "," ").replace("  "," ").split(" "),l[e].splice(1,1),x+='"'+l[e][0]+'": ',l[e].splice(0,1),$.each(l[e],function(t,a){l[e][t]='"'+a+'"'}),x+="["+l[e]+"], ")}),x=JSON.parse("{"+x.slice(0,-2)+"}")),F="arabic"==e?"RTL":"LTR",n(a)}function n(e){var t=e.toString().split(","),a=new Array,o=new Array(47);$.each(t,function(e,t){a[e]=t.toString().replace(/(\t+|\s+)/g," "),a[e]=a[e].split(" "),void 0!==K[a[e][0]]&&(o[K[a[e][0]]]=a[e])}),$(".keyboard-wrapper").length?(g(),L=!0):($("body").prepend('<div class="keyboard-blackout-background"></div><div class="keyboard-wrapper"></div>'),L=!1),c(o.slice(0,13)),c(o.slice(13,26)),c(o.slice(26,37)),c(o.slice(37,47)),s("default"),p(),y(),f(),q||($(".keyboard-blackout-background").hide(),$(".keyboard-wrapper").hide())}function i(e){$(".keyboard-row:last").append('<button class="keyboard-key keyboard-key-sm"></button>'),$(".keyboard-key:last").data("keyDataObject",e)}function c(e){var t;$(".keyboard-wrapper").append('<div class="keyboard-row"></div>'),$.each(e,function(e,a){t=void 0!==a?{default:d(a[C.default-1],a[1]),shift:d(a[C.shift-1],a[1]),altgrp:d(a[C.altgrp-1],a[1]),shift_altgrp:d(a[C.shift_altgrp-1],a[1])}:{default:"-1",shift:"-1",altgrp:"-1",shift_altgrp:"-1"},i(t)})}function d(e,t){var a=e;return"%%"==e?a=x[t]:void 0===e&&(a="-1"),a}function p(){$(".keyboard-action-wrapper").length||$(".keyboard-wrapper").prepend('<div class="keyboard-action-wrapper"><button class="keyboard-action-button keyboard-cancel-button">Cancel</button><input type="text" class="keyboard-input-field"><button class="keyboard-action-button keyboard-accept-button">Accept</button></div>'),$(".keyboard-row:eq(0)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="backspace">Backspace</button>'),$(".keyboard-row:eq(1)").prepend('<button class="keyboard-key keyboard-key-lg" data-keyval="tab">Tab</button>'),$(".keyboard-row:eq(2)").prepend('<button class="keyboard-key keyboard-key-lg caps-lock-key" data-keyval="caps lock">Caps Lock</button>'),$(".keyboard-row:eq(2)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="enter">Enter</button>'),$(".keyboard-row:eq(3)").prepend('<button class="keyboard-key keyboard-key-lg" data-keyval="shift">Shift</button>'),$(".keyboard-row:eq(3)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="shift">Shift</button>'),$(".keyboard-wrapper").append('<div class="keyboard-row"></div>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="ctrl">Ctrl</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="language">Language</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="alt">Alt</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-xl" data-keyval="space">&nbsp;</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="alt grp">Alt Grp</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="spare">&nbsp;</button>'),$(".keyboard-row:eq(4)").append('<button class="keyboard-key keyboard-key-lg" data-keyval="ctrl">Ctrl</button>')}function y(){var e,t,a,o,r=$(".keyboard-row").width(),l=15,n=2*$(".keyboard-key").css("margin-right").match(/[0-9]/),i=(r-l*n)/l,c=r/3;$(".keyboard-row").each(function(){e=$(this).children(".keyboard-key-sm").length,t=$(this).children(".keyboard-key-lg").length,a=$(this).children(".keyboard-key-xl").length,o=(r-(e+t+a)*n-e*i-a*c)/t,$(this).children(".keyboard-key-sm").width(i),$(this).children(".keyboard-key-lg").width(o),$(this).children(".keyboard-key-xl").width(c)})}function s(e){var t,a,o="";!E.caps||E.shift||E.altgrp?E.caps||E.shift||E.altgrp||(e="default"):(e="default",$(".caps-lock-key").addClass("caps-lock-key-active")),E.caps||$(".caps-lock-key").removeClass("caps-lock-key-active"),""!=E.shift_altgrp&&"shift_altgrp"!=e&&(E.shift_altgrp=""),$(".keyboard-key").each(function(){o="";try{t=$(this),a=t.data("keyDataObject"),4==a[e].length?(t.html("&#x"+a[e]+";"),t.data("keyval",t.html())):5==a[e].length&&a[e].match("@")?(t.html("&#x"+a[e].replace("@","")+";"),t.data("keyval",t.html())):a[e].constructor===Array?($.each(a[e],function(e,t){o+="&#x"+t+";"}),t.html(o),t.data("keyval",t.html())):"-1"==a[e]||"%%"==a[e]||0==a[e].length?(t.html("&nbsp;"),t.data("keyval","")):(t.html(a[e]),t.data("keyval",t.html())),E.shift||!E.caps||E.altgrp||(t.html(1==t.html().length?t.html().toUpperCase():t.html()),t.data("keyval",1==t.html().length?t.html():t.data("keyval")))}catch(e){}})}function k(t){var a=("0000"+t.charCodeAt(0).toString(16)).slice(-4),o=$(".keyboard-input-field")[0].selectionStart;if(t=t.replace("&lt;","<").replace("&gt;",">").replace(/\bspace/," "),t.length>2)switch(_="",t){case"shift":E.shift=!E.shift,E.caps=!1,E.altgrp=!1,"altgrp"==E.shift_altgrp?(s("shift_altgrp"),E.shift_altgrp=""):"shift"==E.shift_altgrp?(s("shift"),E.shift_altgrp=""):(s("shift"),E.shift_altgrp="shift");break;case"caps lock":E.shift=!1,E.caps=!E.caps,E.altgrp=!1,s("caps");break;case"alt grp":E.shift=!1,E.caps=!1,E.altgrp=!E.altgrp,"shift"==E.shift_altgrp?(s("shift_altgrp"),E.shift_altgrp=""):"altgrp"==E.shift_altgrp?(s("altgrp"),E.shift_altgrp=""):(s("altgrp"),E.shift_altgrp="altgrp");break;case"backspace":$(".keyboard-input-field").val($(".keyboard-input-field").val().slice(0,o-1)+$(".keyboard-input-field").val().slice(o)),o-=1,$(".keyboard-input-field").focus(),$(".keyboard-input-field")[0].selectionStart=o,$(".keyboard-input-field")[0].selectionEnd=o;break;case"space":break;case"enter":e.enterKey&&"function"==typeof e.enterKey&&e.enterKey();break;case"tab":e.tabKey&&"function"==typeof e.tabKey&&e.tabKey();break;case"ctrl":e.ctrlKey&&"function"==typeof e.ctrlKey&&e.ctrlKey();break;case"alt":e.altKey&&"function"==typeof e.altKey&&e.altKey();break;case"language":v+1<=e.language.length-1?v++:v=0,h(),r(e.language[v]),e.languageKey&&"function"==typeof e.languageKey&&e.languageKey();break;case"spare":e.spareKey&&"function"==typeof e.spareKey&&optionsspareKey()}else{if(E.shift=!1,E.altgrp=!1,s("default"),_=m[a],_||O){if(t="",void 0===_&&O){var l=String.fromCharCode("0x"+O[a]);l&&void 0!==O[a]&&(t=l)}O=_}$(".keyboard-input-field").attr("dir",F),$(".keyboard-input-field").val($(".keyboard-input-field").val().slice(0,o)+t+$(".keyboard-input-field").val().slice(o)),o+=t.length,$(".keyboard-input-field").focus(),$(".keyboard-input-field")[0].selectionStart=o,$(".keyboard-input-field")[0].selectionEnd=o}}function b(){$(".keyboard-input-field").val(""),h(),q=!1,r(e.language[v])}function u(){w.is("input")?w.val($(".keyboard-input-field").val()):w.html($(".keyboard-input-field").val()),$(".keyboard-input-field").val(""),h(),q=!1,r(e.language[v])}function f(){var t=$(window).width(),a=$(window).height(),o=$(".keyboard-wrapper").height(),r=$(".keyboard-wrapper").width();switch($(".keyboard-key").css("background-color",e.keyColor),$(".keyboard-key").css("color",e.keyTextColor),$(".keyboard-cancel-button").css("background-color",e.cancelColor),$(".keyboard-cancel-button").css("color",e.cancelTextColor),$(".keyboard-accept-button").css("background-color",e.acceptColor),$(".keyboard-accept-button").css("color",e.acceptTextColor),$(".keyboard-blackout-background").css("background-color","rgba("+e.blackoutColor+")"),e.keyboardPosition){case"top":$(".keyboard-wrapper").css("top","20px");break;case"middle":$(".keyboard-wrapper").css("top",((a-o)/2).toString()+"px");break;default:$(".keyboard-wrapper").css("bottom","20px")}$(".keyboard-wrapper").css("left",((t-r)/2).toString()+"px")}function g(){h(),$(".keyboard-row").remove()}function h(){for(var e in E)E.hasOwnProperty(e)&&(E[e]=!1)}var w,v,C,m,x,K={29:0,"02":1,"03":2,"04":3,"05":4,"06":5,"07":6,"08":7,"09":8,"0a":9,"0b":10,"0c":11,"0d":12,10:13,11:14,12:15,13:16,14:17,15:18,16:19,17:20,18:21,19:22,"1a":23,"1b":24,"2b":25,"1e":26,"1f":27,20:28,21:29,22:30,23:31,24:32,25:33,26:34,27:35,28:36,"2c":37,"2d":38,"2e":39,"2f":40,30:41,31:42,32:43,33:44,34:45,35:46},E={shift:!1,caps:!1,altgrp:!1,shift_altgrp:""},S=$(this),T=!1,A={keyboardFile:"",arrayPosition:""},_="",O=!1,F="LTR",q=!1,L=!1;e={language:"undefined"==typeof e.language?"english":e.language,keyColor:"undefined"==typeof e.keyColor?"#E0E0E0":e.keyColor,keyTextColor:"undefined"==typeof e.keyTextColor?"#555555":e.keyTextColor,capsLightColor:"undefined"==typeof e.capsLightColor?"#3498DB":e.capsLightColor,enterKey:"undefined"==typeof e.enterKey?"":e.enterKey,tabKey:"undefined"==typeof e.tabKey?"":e.tabKey,ctrlKey:"undefined"==typeof e.ctrlKey?"":e.ctrlKey,altKey:"undefined"==typeof e.altKey?"":e.altKey,spareKey:"undefined"==typeof e.spareKey?"":e.spareKey,languageKey:"undefined"==typeof e.languageKey?"":e.languageKey,keyboardPosition:"undefined"==typeof e.keyboardPosition?"bottom":e.keyboardPosition,inputType:t(e.inputType),cancelColor:"undefined"==typeof e.cancelColor?"#E74C3C":e.cancelColor,cancelTextColor:"undefined"==typeof e.cancelTextColor?"#FFFFFF":e.cancelTextColor,acceptColor:"undefined"==typeof e.acceptColor?"#2ECC71":e.acceptColor,acceptTextColor:"undefined"==typeof e.acceptTextColor?"#FFFFFF":e.acceptTextColor,blackoutColor:"undefined"==typeof e.blackoutColor?"25, 25, 25, 0.9":e.blackoutColor,allowEscapeCancel:"undefined"==typeof e.allowEscapeCancel||e.allowEscapeCancel,allowEnterAccept:"undefined"==typeof e.allowEnterAccept||e.allowEnterAccept},e.language=e.language.split(","),$.each(e.language,function(t,a){e.language[t]=a.trim()}),a(),$(window).resize(function(){if(!T){T=!0;setTimeout(function(){r(e.language[v]),T=!1},500)}})};